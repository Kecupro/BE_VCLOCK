/*
  Script t·∫°o voucher m·∫´u cho testing
  T·∫°o 20 voucher v·ªõi c√°c lo·∫°i target_audience kh√°c nhau
  
  Usage: node scripts/seed-vouchers.js
*/

const mongoose = require('mongoose');
const voucherSchema = require('../model/schemaVoucher');

// MongoDB connection
const uri = process.env.MONGODB_URI || 'mongodb://cu:123@ac-ekia82x-shard-00-00.2ceby11.mongodb.net:27017,ac-ekia82x-shard-00-01.2ceby11.mongodb.net:27017,ac-ekia82x-shard-00-02.2ceby11.mongodb.net:27017/DATN_V3?ssl=true&replicaSet=atlas-10u8ug-shard-0&authSource=admin&retryWrites=true&w=majority&appName=Cluster0';
const conn = mongoose.createConnection(uri);

// Helper functions
function addDays(date, days) {
  const d = new Date(date);
  d.setDate(d.getDate() + days);
  return d;
}

function formatDate(date) {
  return date.toISOString().split('T')[0];
}

// T·∫°o 20 voucher m·∫´u v·ªõi target_audience r√µ r√†ng
function createSampleVouchers() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // B·ªè gi·ªù ph√∫t gi√¢y
  
  return [
    // ===== VOUCHER D√ÄNH CHO KH√ÅCH H√ÄNG M·ªöI (new_customer) =====
    {
      voucher_name: 'Ch√†o m·ª´ng kh√°ch h√†ng m·ªõi - Gi·∫£m 15%',
      voucher_code: 'NEW15',
      start_date: addDays(today, -1), // B·∫Øt ƒë·∫ßu t·ª´ h√¥m qua
      end_date: addDays(today, 30),   // K·∫øt th√∫c sau 30 ng√†y
      discount_type: 'percentage',
      discount_value: 15,
      minimum_order_value: 0,
      max_discount: 200000,
      target_audience: 'new_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Kh√°ch h√†ng m·ªõi - Gi·∫£m 20%',
      voucher_code: 'NEW20',
      start_date: addDays(today, -1),
      end_date: addDays(today, 45),
      discount_type: 'percentage',
      discount_value: 20,
      minimum_order_value: 100000,
      max_discount: 300000,
      target_audience: 'new_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Kh√°ch h√†ng m·ªõi - Gi·∫£m 100K',
      voucher_code: 'NEW100K',
      start_date: addDays(today, -1),
      end_date: addDays(today, 60),
      discount_type: 'fixed',
      discount_value: 100000,
      minimum_order_value: 500000,
      max_discount: null,
      target_audience: 'new_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Kh√°ch h√†ng m·ªõi - Gi·∫£m 200K',
      voucher_code: 'NEW200K',
      start_date: addDays(today, -1),
      end_date: addDays(today, 40),
      discount_type: 'fixed',
      discount_value: 200000,
      minimum_order_value: 1000000,
      max_discount: null,
      target_audience: 'new_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Kh√°ch h√†ng m·ªõi - Gi·∫£m 25%',
      voucher_code: 'NEW25',
      start_date: addDays(today, 2),  // S·∫Øp b·∫Øt ƒë·∫ßu
      end_date: addDays(today, 35),
      discount_type: 'percentage',
      discount_value: 25,
      minimum_order_value: 500000,
      max_discount: 400000,
      target_audience: 'new_customer',
      created_at: now,
      updated_at: now
    },

    // ===== VOUCHER D√ÄNH CHO KH√ÅCH H√ÄNG TH√ÇN THI·∫æT (loyal_customer) =====
    {
      voucher_name: 'Kh√°ch h√†ng th√¢n thi·∫øt - Gi·∫£m 20%',
      voucher_code: 'LOYAL20',
      start_date: addDays(today, -1),
      end_date: addDays(today, 50),
      discount_type: 'percentage',
      discount_value: 20,
      minimum_order_value: 500000,
      max_discount: 400000,
      target_audience: 'loyal_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Kh√°ch h√†ng th√¢n thi·∫øt - Gi·∫£m 30%',
      voucher_code: 'LOYAL30',
      start_date: addDays(today, -1),
      end_date: addDays(today, 55),
      discount_type: 'percentage',
      discount_value: 30,
      minimum_order_value: 800000,
      max_discount: 600000,
      target_audience: 'loyal_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Kh√°ch h√†ng th√¢n thi·∫øt - Gi·∫£m 300K',
      voucher_code: 'LOYAL300K',
      start_date: addDays(today, -1),
      end_date: addDays(today, 70),
      discount_type: 'fixed',
      discount_value: 300000,
      minimum_order_value: 1500000,
      max_discount: null,
      target_audience: 'loyal_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Kh√°ch h√†ng th√¢n thi·∫øt - Gi·∫£m 500K',
      voucher_code: 'LOYAL500K',
      start_date: addDays(today, 1),  // S·∫Øp b·∫Øt ƒë·∫ßu
      end_date: addDays(today, 45),
      discount_type: 'fixed',
      discount_value: 500000,
      minimum_order_value: 2000000,
      max_discount: null,
      target_audience: 'loyal_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Kh√°ch h√†ng th√¢n thi·∫øt - Gi·∫£m 35%',
      voucher_code: 'LOYAL35',
      start_date: addDays(today, 3),  // S·∫Øp b·∫Øt ƒë·∫ßu
      end_date: addDays(today, 60),
      discount_type: 'percentage',
      discount_value: 35,
      minimum_order_value: 1200000,
      max_discount: 800000,
      target_audience: 'loyal_customer',
      created_at: now,
      updated_at: now
    },

    // ===== VOUCHER D√ÄNH CHO KH√ÅCH H√ÄNG VIP (vip_customer) =====
    {
      voucher_name: 'VIP - Gi·∫£m 800K',
      voucher_code: 'VIP800K',
      start_date: addDays(today, -1),
      end_date: addDays(today, 90),
      discount_type: 'fixed',
      discount_value: 800000,
      minimum_order_value: 3000000,
      max_discount: null,
      target_audience: 'vip_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'VIP - Gi·∫£m 40%',
      voucher_code: 'VIP40',
      start_date: addDays(today, -1),
      end_date: addDays(today, 100),
      discount_type: 'percentage',
      discount_value: 40,
      minimum_order_value: 3000000,
      max_discount: 1000000,
      target_audience: 'vip_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'VIP - Gi·∫£m 1.5 tri·ªáu',
      voucher_code: 'VIP1M5',
      start_date: addDays(today, 1),  // S·∫Øp b·∫Øt ƒë·∫ßu
      end_date: addDays(today, 80),
      discount_type: 'fixed',
      discount_value: 1500000,
      minimum_order_value: 6000000,
      max_discount: null,
      target_audience: 'vip_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'VIP - Gi·∫£m 50%',
      voucher_code: 'VIP50',
      start_date: addDays(today, 2),  // S·∫Øp b·∫Øt ƒë·∫ßu
      end_date: addDays(today, 95),
      discount_type: 'percentage',
      discount_value: 50,
      minimum_order_value: 4000000,
      max_discount: 1200000,
      target_audience: 'vip_customer',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'VIP - Gi·∫£m 2 tri·ªáu',
      voucher_code: 'VIP2M',
      start_date: addDays(today, -1),
      end_date: addDays(today, 120),
      discount_type: 'fixed',
      discount_value: 2000000,
      minimum_order_value: 8000000,
      max_discount: null,
      target_audience: 'vip_customer',
      created_at: now,
      updated_at: now
    },

    // ===== VOUCHER D√ÄNH CHO T·∫§T C·∫¢ (all) =====
    {
      voucher_name: 'Gi·∫£m gi√° 10% cho t·∫•t c·∫£',
      voucher_code: 'SALE10',
      start_date: addDays(today, -1),
      end_date: addDays(today, 25),
      discount_type: 'percentage',
      discount_value: 10,
      minimum_order_value: 0,
      max_discount: 200000,
      target_audience: 'all',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Gi·∫£m gi√° 15% cho t·∫•t c·∫£',
      voucher_code: 'SALE15',
      start_date: addDays(today, 1),  // S·∫Øp b·∫Øt ƒë·∫ßu
      end_date: addDays(today, 40),
      discount_type: 'percentage',
      discount_value: 15,
      minimum_order_value: 300000,
      max_discount: 300000,
      target_audience: 'all',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Gi·∫£m 100K cho t·∫•t c·∫£',
      voucher_code: 'SALE100K',
      start_date: addDays(today, -1),
      end_date: addDays(today, 35),
      discount_type: 'fixed',
      discount_value: 100000,
      minimum_order_value: 500000,
      max_discount: null,
      target_audience: 'all',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Gi·∫£m gi√° 20% cho t·∫•t c·∫£',
      voucher_code: 'SALE20',
      start_date: addDays(today, 2),  // S·∫Øp b·∫Øt ƒë·∫ßu
      end_date: addDays(today, 50),
      discount_type: 'percentage',
      discount_value: 20,
      minimum_order_value: 600000,
      max_discount: 400000,
      target_audience: 'all',
      created_at: now,
      updated_at: now
    },
    {
      voucher_name: 'Gi·∫£m 300K cho t·∫•t c·∫£',
      voucher_code: 'SALE300K',
      start_date: addDays(today, -1),
      end_date: addDays(today, 45),
      discount_type: 'fixed',
      discount_value: 300000,
      minimum_order_value: 1500000,
      max_discount: null,
      target_audience: 'all',
      created_at: now,
      updated_at: now
  }
  ];
}

// Main function
async function seedVouchers() {
  try {
    console.log('üå± B·∫Øt ƒë·∫ßu t·∫°o voucher m·∫´u...');
    
    const VoucherModel = conn.model('vouchers', voucherSchema);
    const vouchers = createSampleVouchers();
    
    console.log(`üìã T·∫°o ${vouchers.length} voucher m·∫´u:`);
    console.log('   - 5 voucher cho kh√°ch h√†ng m·ªõi (new_customer)');
    console.log('   - 5 voucher cho kh√°ch h√†ng th√¢n thi·∫øt (loyal_customer)');
    console.log('   - 5 voucher cho kh√°ch h√†ng VIP (vip_customer)');
    console.log('   - 5 voucher cho t·∫•t c·∫£ (all)');
    
    // X√≥a t·∫•t c·∫£ voucher c≈© (optional)
    const deleteResult = await VoucherModel.deleteMany({});
    console.log(`üóëÔ∏è  ƒê√£ x√≥a ${deleteResult.deletedCount} voucher c≈©`);
    
    // T·∫°o voucher m·ªõi
    const result = await VoucherModel.insertMany(vouchers);
    console.log(`‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng ${result.length} voucher m·ªõi!`);
    
    // Hi·ªÉn th·ªã th√¥ng tin voucher
    console.log('\nüìä Chi ti·∫øt voucher ƒë√£ t·∫°o:');
    result.forEach((voucher, index) => {
      const status = new Date() < voucher.start_date ? 'üü° S·∫Øp b·∫Øt ƒë·∫ßu' : 
                    new Date() > voucher.end_date ? 'üî¥ H·∫øt h·∫°n' : 'üü¢ ƒêang ho·∫°t ƒë·ªông';
      console.log(`   ${index + 1}. ${voucher.voucher_name} (${voucher.voucher_code})`);
      console.log(`      - ƒê·ªëi t∆∞·ª£ng: ${voucher.target_audience}`);
      console.log(`      - Gi√° tr·ªã: ${voucher.discount_type === 'percentage' ? voucher.discount_value + '%' : voucher.discount_value.toLocaleString('vi-VN') + 'ƒë'}`);
      console.log(`      - Th·ªùi gian: ${formatDate(voucher.start_date)} ‚Üí ${formatDate(voucher.end_date)}`);
      console.log(`      - Tr·∫°ng th√°i: ${status}`);
      console.log('');
    });
    
  } catch (error) {
    console.error('‚ùå L·ªói khi t·∫°o voucher:', error);
  } finally {
    await conn.close();
    console.log('üîå ƒê√£ ƒë√≥ng k·∫øt n·ªëi MongoDB');
    process.exit(0);
  }
}

// Ch·∫°y script
seedVouchers();


